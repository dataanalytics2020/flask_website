{% extends "base.html" %}
{% block title %}ポストテスト{% endblock %}
{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <div class='row justify-content-center'>
        <div class='col-lg-8 text-center'>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                  <li class="breadcrumb-item"><a href="/">HOME</a></li>
                  <li class="breadcrumb-item"><a href="/prefecture/{{data.pref_name_en}}">{{data.pref_name_jp}}</a></li>
                  <li class="breadcrumb-item" ><a href="/tomorrow_recommend/{{data.pref_name_en}}/hall/{{data.hall_name}}">{{data.hall_name}}</a></li>
                  <li class="breadcrumb-item active" aria-current="page"><a href="">{{data.target_date_jp}}</a></li>
                </ol>
            </nav>
            <h2 class="heading-17 my-2 ">
                <span>01</span>
                {{data.target_date_jp}}の{{data.hall_name}}のデータ
            </h2>
            {{ data.result_status_df | safe }}
            <h2 class="heading-17 my-2 ">
                <span>02</span>
                機種別バブルチャート分析で見る{{data.hall_name}}のデータ
            </h2>
            <details class="qa-001 my-2">
                <summary>このバブルチャートは何ですか？</summary>
                <p>円の大きさが総差枚を表しています。右に行くほど機種平均G数が大きく、上に行くほど機種平均差枚が大きくなっています。
                    全台系や設定が入っている機種ほど右上にあります。
                    円をタップすると機種別データに飛ぶかその場でデータが見れます。</p>
            </details>
            <div id="chart-container">
                <canvas id="bubbleChart"></canvas>
            </div>
            {{ data.groupby_machine_html | safe }}
        </div>
    </div>
</div>
<style>
#chart-container {
    width: 100%;
    max-width: 1000px;
    height: 440px;
    padding: 0px;
    box-sizing: border-box;
}
.machine_accordion {
    background-color: #fff;
    border-radius: 5px;
    overflow: hidden;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}
.machine_accordion_item {
    border-bottom: 1px solid #e0e0e0;
}
.machine_accordion_header {
    background-color: #f8f8f8;
    padding: 15px;
    cursor: pointer;
    transition: background-color 0.3s;
    display: block;
}
.machine_accordion_header:hover {
    background-color: #e8e8e8;
}
.machine_accordion_content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
    background-color: #fff;
}
.machine_accordion_item input[type="checkbox"] {
    display: none;
}
.machine_accordion_item input[type="checkbox"]:checked + .machine_accordion_header {
    background-color: #e0e0e0;
}
.machine_accordion_item input[type="checkbox"]:checked + .machine_accordion_header + .machine_accordion_content {
    max-height: 1000px; /* 大きな値を設定 */
}
.machine_table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 15px;
}
.machine_table th, .machine_table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
}
.machine_table th {
    background-color: #f2f2f2;
}
.machine_table_container {
    overflow-x: auto;
    padding: 15px;
}
</style>
<script>
// サンプルデータ
    const data = {{ data.bubble_chart_df_data | safe }};
    // バブル内に文字を描画するプラグイン
    const textInBubblePlugin = {
        id: 'textInBubble',
        afterDatasetsDraw(chart, args, pluginOptions) {
            const { ctx } = chart;

            chart.data.datasets.forEach((dataset, datasetIndex) => {
                const meta = chart.getDatasetMeta(datasetIndex);
                if (!meta.visible) return;

                meta.data.forEach((element, index) => {
                    const { x, y } = element.getCenterPoint();
                    const text = data[index].link.replace('#', '').replace('_ave', '');
                    console.log('index',index);
                    console.log('text',text);

                    ctx.save();
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = 'black';
                    ctx.font = `${element.options.radius / 5}px Arial`;
                    ctx.fillText(text, x, y);
                    ctx.restore();
                });
            });
        }
    };
    // バブルサイズの調整関数
    function adjustBubbleSize(totalCoins) {
        const baseSize = Math.abs(totalCoins) / 100;
        return Math.min(Math.max(baseSize, 3), 50); // 最小5、最大30に制限
    }

    // チャートの設定
    const ctx = document.getElementById('bubbleChart').getContext('2d');
    new Chart(ctx, {
        type: 'bubble',
        plugins: [textInBubblePlugin],
        data: {
            datasets: [{
                label: 'スロット機種別データ',
                data: data.map(item => ({
                    x: item.avgGames,
                    y: item.avgCoins,
                    r: adjustBubbleSize(item.totalCoins),
                })),
                backgroundColor: data.map(item => 
                    item.totalCoins >= 0 ? 'rgba(75, 192, 192, 0.6)' : 'rgba(255, 99, 132, 0.6)'
                ),
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const item = data[context.dataIndex];
                            return `${item.machine}\n: \n平均G数: ${item.avgGames}, \n平均差枚: ${item.avgCoins}, \n総差枚: ${item.totalCoins}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: '平均G数'
                    },
                    min: 0,
                    max: 7000
                },
                y: {
                    title: {
                        display: true,
                        text: '平均差枚'
                    },
                    min: -3000,
                    max: 5000
                }
            },
            onClick: (e, elements) => {
                if (elements.length > 0) {
                    console.log('elements[0]',elements[0].index);
                    console.log('elementsは',elements);
                    datapoint = data[elements[0].index];
                    if (datapoint.link) {
                        document.querySelector(datapoint.link).scrollIntoView({
                            behavior: 'smooth'
                        });
                    }
                }
            }
        }
    });
</script>
{% endblock %}